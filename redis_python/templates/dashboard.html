<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Employee Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      padding: 2rem;
      background-color: #f8f9fa;
    }
    .card {
      margin-bottom: 2rem;
    }
  </style>
</head>
<body>
  <h2 class="mb-4">ðŸ“Š Employee Analytics Dashboard</h2>

  <div class="card p-3">
    <h5>Total Employees: <span id="total-count">Loading...</span></h5>
    <div class="mt-2">
      <label for="roleFilter" class="form-label">Filter by Role:</label>
      <select id="roleFilter" class="form-select">
        <option value="">All Roles</option>
      </select>
    </div>
    <div class="mt-3">
      <h6>Role Counts:</h6>
      <ul id="roleCounts" class="list-group"></ul>
    </div>
  </div>

  <div class="card p-3">
    <h5>Role Distribution</h5>
    <canvas id="rolePieChart" height="100"></canvas>
  </div>

  <div class="card p-3">
    <h5>Age Trends (Simulated)</h5>
    <canvas id="ageLineChart" height="100"></canvas>
  </div>

  <div class="card p-3">
    <h5>Age Statistics</h5>
    <ul id="ageStats" class="list-group"></ul>
  </div>

  <div class="card p-3 text-end">
    <a href="/export-csv" class="btn btn-success">ðŸ“¥ Download CSV</a>
  </div>

  <script>
    let dashboardData = null;
    let pieChart, lineChart;

    async function loadDashboard() {
      try {
        const res = await fetch("/dashboard", { credentials: "include" });
        if (!res.ok) throw new Error("Failed to fetch dashboard data");
        dashboardData = await res.json();

        document.getElementById("total-count").textContent = dashboardData.total_employees;

        populateRoleFilter(dashboardData.roles);
        renderCharts(dashboardData.roles, dashboardData.age_stats);
        updateRoleCounts(dashboardData.roles);
      } catch (err) {
        console.error(err);
        document.body.innerHTML += `<p class="text-danger">Failed to load dashboard data.</p>`;
      }
    }

    function populateRoleFilter(roles) {
      const filter = document.getElementById("roleFilter");
      Object.keys(roles).forEach(role => {
        const option = document.createElement("option");
        option.value = role;
        option.textContent = role;
        filter.appendChild(option);
      });

      filter.addEventListener("change", filterByRole);
    }

    function updateRoleCounts(roles) {
      const roleList = document.getElementById("roleCounts");
      roleList.innerHTML = "";

      Object.entries(roles).forEach(([role, count]) => {
        const item = document.createElement("li");
        item.className = "list-group-item d-flex justify-content-between align-items-center";
        item.textContent = role;
        const badge = document.createElement("span");
        badge.className = "badge bg-primary rounded-pill";
        badge.textContent = count;
        item.appendChild(badge);
        roleList.appendChild(item);
      });
    }

    function filterByRole() {
      const selectedRole = document.getElementById("roleFilter").value;

      if (!selectedRole || !dashboardData.roles[selectedRole]) {
        renderCharts(dashboardData.roles, dashboardData.age_stats);
        updateRoleCounts(dashboardData.roles);
        return;
      }

      const filteredRoles = { [selectedRole]: dashboardData.roles[selectedRole] };
      renderCharts(filteredRoles, dashboardData.age_stats);
      updateRoleCounts(filteredRoles);
    }

    function renderCharts(roles, ageStats) {
      if (pieChart) pieChart.destroy();
      if (lineChart) lineChart.destroy();

      const pieCtx = document.getElementById("rolePieChart").getContext("2d");
      pieChart = new Chart(pieCtx, {
        type: "pie",
        data: {
          labels: Object.keys(roles),
          datasets: [{
            data: Object.values(roles),
            backgroundColor: ["#0d6efd", "#198754", "#ffc107", "#dc3545", "#6f42c1"]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" }
          }
        }
      });

      const lineCtx = document.getElementById("ageLineChart").getContext("2d");
      lineChart = new Chart(lineCtx, {
        type: "line",
        data: {
          labels: ["2019", "2020", "2021", "2022", "2023", "2024", "2025"],
          datasets: [{
            label: "Average Age",
            data: [
              ageStats.average_age - 2,
              ageStats.average_age - 1.5,
              ageStats.average_age - 1,
              ageStats.average_age - 0.5,
              ageStats.average_age,
              ageStats.average_age + 0.5,
              ageStats.average_age + 1
            ],
            borderColor: "#0d6efd",
            fill: false
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          }
        }
      });

      const ageList = document.getElementById("ageStats");
      ageList.innerHTML = `
        <li class="list-group-item">Average Age: ${ageStats.average_age ?? "N/A"}</li>
        <li class="list-group-item">Youngest: ${ageStats.youngest ?? "N/A"}</li>
        <li class="list-group-item">Oldest: ${ageStats.oldest ?? "N/A"}</li>
      `;
    }

    loadDashboard();
  </script>

  {% include 'footer.html' %}
</body>
</html>
